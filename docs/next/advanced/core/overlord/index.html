<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-134504127-4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-134504127-4",{})</script>
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Muta Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Muta Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">

<title data-react-helmet="true">Overlord | Docs | Muta</title>

<meta data-react-helmet="true" property="og:title" content="Muta"><meta data-react-helmet="true" name="docsearch:version" content="next"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="## 目标"><meta data-react-helmet="true" property="og:description" content="## 目标"><meta data-react-helmet="true" property="og:url" content="docs.muta.dev/docs/next/advanced/core/overlord">

<link data-react-helmet="true" rel="shortcut icon" href="/img/muta-logo.png">


<link rel="stylesheet" href="/styles.280b09d0.css">


<link rel="preload" href="/styles.aab16a3e.js" as="script">

<link rel="preload" href="/runtime~main.03453cf4.js" as="script">

<link rel="preload" href="/main.e4220dee.js" as="script">

<link rel="preload" href="/1.a4d1db7c.js" as="script">

<link rel="preload" href="/2.ddac714a.js" as="script">

<link rel="preload" href="/3.18f4c7ce.js" as="script">

<link rel="preload" href="/1be78505.0761eff7.js" as="script">

<link rel="preload" href="/c6c6e257.5904db9a.js" as="script">

<link rel="preload" href="/5.15d1d23d.js" as="script">

<link rel="preload" href="/17896441.8bceb62d.js" as="script">

<link rel="preload" href="/d9b1b66c.8da74149.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_OaSq"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/muta.svg" alt="muta"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/about/what-is-muta">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/about/what-is-muta">Master/Unreleased</a></li><li><a class="dropdown__link" href="/docs/about/what-is-muta">0.2.0-beta.4/Latest Stable</a></li></ul></div><a class="navbar__item navbar__link" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/community/">Communtiy</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a activeclassname="navbar__link--active" class="navbar__item navbar__link">Translate</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/docs_zh/about/what-is-muta">中文</a></li><li><a class="dropdown__link" href="/docs/about/what-is-muta">English</a></li></ul></div><a class="navbar__item navbar__link" href="/versions">v0.2.0-beta.4</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/muta.svg" alt="muta"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" position="left" href="/docs/about/what-is-muta">Docs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/about/what-is-muta">Master/Unreleased</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/about/what-is-muta">0.2.0-beta.4/Latest Stable</a></li></ul></li><li class="menu__list-item"><a class="menu__link" position="left" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" position="right" href="/community/">Communtiy</a></li><li class="menu__list-item"><a activeclassname="navbar__link--active" class="menu__link menu__link--sublist" position="right">Translate</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs_zh/about/what-is-muta">中文</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/about/what-is-muta">English</a></li></ul></li><li class="menu__list-item"><a class="menu__link" position="right" href="/versions">v0.2.0-beta.4</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="menu__link header-github-link" position="right"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container_3Vzv container container--l"><div class="sidebar_dgnY"><div class="docs-sidebar sidebar_25T_"><a class="sidebarLogo_3JkW" href="/"></a><div class="menu menu--responsive menu_1e9D"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_1hKf" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><div class="title">About</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/about/what-is-muta/">What is Muta?</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/about/concepts/">Basic Concepts</a></li></ul></li><li class="menu__list-item"><div class="title">Setup</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/getting-started/">Getting Started</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/setup/config/">Configuration</a><ul class="menu__list"><li class="menu__list-item menu__list-item-hidden"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/config/">hidden</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/genesis-config/">Genesis Configuration</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/node-config/">Node Configuration</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/cargo-config/">Cargo configuration</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/deploy/">Deployment</a></li></ul></li><li class="menu__list-item"><div class="title">Development</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/dev-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-dev/">Service Dev Guide</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/dev/service-list/service-list/">Service List</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/service-list/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/metadata-service/">Metadata Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/asset-service/">Asset Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/auth-service/">Authorization Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/multi-sig-service/">Multi-signature Service</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/poe-chain/">Develop a Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/dex/">Develop a Dapp Chain</a></li></ul></li><li class="menu__list-item"><div class="title">Advanced</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/arch/">Architecture</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/transaction-block/">Transaction, Block and State</a></li><li class="menu__list-item"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/advanced/core/overlord/">Core Design</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/overlord/">Overlord</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/network/">P2P Network</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/mempool/">Mempool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/storage/">Storage</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/crypto/">Cryptography</a></li></ul></li><li class="menu__list-item"><div class="title">Toolchain</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/sdk-js/">JS SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/sdk-java/">JAVA SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/muta-cli/">Muta CLI</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/benchmark-tool/">Muta Benchmark Tool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/keypair/">Muta Keypair Tool</a></li></ul></li><li class="menu__list-item"><div class="title">Reference</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/ref/faq/">FAQ</a></li><li class="menu__list-item"><a class="menu__link" to="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/" target="_blank" rel="noreferrer noopener" href="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/">Contributing</a></li></ul></li></ul></div></div></div><main class="main_2vyu"><div><div class="container_2j_u"><div class="leftCol_3JzO"><div class="docItemContainer_"><article><span style="vertical-align:top" class="badge badge--info">Version: next</span><header><div class="badges"></div><h1 class="docTitle_cWlf">Overlord</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="目标"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#目标" title="Direct link to heading">#</a>目标</h2><p>Overlord 的目标是成为能够支持上百个共识节点，满足数千笔每秒的交易处理能力，且交易延迟不超过数秒的 BFT 共识算法。简单来讲，就是能够满足大部分现实业务需求的高性能共识算法。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="设计背景"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#设计背景" title="Direct link to heading">#</a>设计背景</h2><p>在区块链中，一次共识至少包含两层语义：</p><ol><li>完成交易定序</li><li>对最新状态达成共识</li></ol><p>对于 UTXO 模型的区块链来说，新状态隐含在交易输出中，因此 1 和 2 是一体不可分割的。而对于 Account 模型的区块链来说，交易中并没有包含状态，只有执行完交易才能生成最新状态，状态用单独的一颗 MPT 树保存。</p><p>在 Account 模型中，为了实现第二层语义，常用的办法是，共识节点在打包新区块之前执行完区块中的所有交易，以计算出最新状态保存到块头中。包含了最新状态的区块达成共识后，区块中的交易完成了定序，同时最新状态亦完成了共识，任何节点可以重放区块中的交易验证状态的正确性。然而，这种处理方法制约了 BFT 类共识算法的交易处理能力。如下图所示，当高度为 h 的区块 B(h) 达成共识后，高度为 h+1 的新 leader 打包并执行 B(h+1) 后才能广播 B(h+1)，其他共识节点收到 B(h+1) 后必须再执行 B(h+1) 以验证其正确性。在共识过程中，这两次串行的区块执行过程拖慢了共识效率。</p><p><img src="/docs-img/block_process.png"></p><p>一种改进的办法是，Leader 在打包新区块时并不立即执行该块，待区块达成共识后，共识节点才执行该块生成新的状态，下一个高度的 Leader 将新状态与下一个区块一起参与共识。这种办法省掉了一次区块执行过程。</p><p>当从更微观的角度来审察这种改进方案时，我们发现其仍然存在很大的改进空间。这是因为，任何一个共识节点的共识模块和执行模块在整个共识过程中始终是串行的，如上图所示，当共识模块在对区块共识时，执行模块始终是空闲的，反之亦然。如果能够将执行模块和共识模块并行，那么共识的交易处理能力理论上能够达到执行模块的最大处理极限。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="overlord-协议"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#overlord-协议" title="Direct link to heading">#</a>Overlord 协议</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="总体设计"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#总体设计" title="Direct link to heading">#</a>总体设计</h3><p>Overlord 的核心思想是解耦交易定序与状态共识。</p><p>我们用 B(h, S, T) 表示高度为 h 的区块，其包含的状态是 S，定序的交易集合是 T。在共识的第二层语义中，人们对 S 的解读往往是执行完 T 后的状态，正是这种思维定势使得执行模块和共识模块无法并行。如果将 S 理解为是共识模块在开始对 B(h, S, T) 共识时，执行模块执行达到的最新状态，那么共识模块将无需等待执行模块执行新的区块，而执行模块只需要沿着已定序的交易向前执行。这样，共识模块可以连续向前推进，不断将新交易定序，同时完成执行模块的最新状态共识; 执行模块也可以连续执行已定序的交易集合，直到将所有已定序的交易执行完毕。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="协议描述"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#协议描述" title="Direct link to heading">#</a>协议描述</h3><p>在 Overlord 中，我们将达成共识的区块称为 <em>block</em>。<em>block</em> 包含 Header 和 Body 两部分（如下图所示）。<em>block</em> 的核心结构如下图所示，<code>height</code> 是单调递增的数值，相当于高度；<code>prev_hash</code> 是上一个 <em>block</em> 的哈希；<code>order_root</code> 是包含在 Body 中的所有待定序的交易的 merkle root；<code>state_root</code> 表示最新的世界状态的 MPT Root；<code>confirm_roots</code> 表示从上一个 <em>block</em> 的 <code>state_root</code> 到当前 <em>block</em> 的 <code>state_root</code> 之间执行模块向前推进的 <code>order_root</code> 集合；<code>receipt_roots</code> 记录被执行的每一个 <code>order_root</code> 所对应的 <code>receipt_root</code>；<code>proof</code> 是对上一个 <em>block</em> 的证明。</p><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i><p>Overlord 是确定性共识，但是需要特别注意的是，区块头中所包含的 proof 是用来验证上一个块，而非当前区块。因此，对于最新区块而言，能证明其合法性的 proof 将被尚未出现的下一个区块包含，那么如何验证最新区块的合法性呢？实际上，诚实节点在将最新区块持久化之前，已经获得了对该区块的 proof 并进行了合法性验证，因此从诚实节点获取的最新区块是经过验证并且可以相信不会回滚的。</p></div><p><img src="/docs-img/block.png"></p><p>在具体的方案中，共识模块批量打包交易进行共识, 达成共识后, 将已定序的交易集合添加到待执行的队列中, 执行模块以交易集合为单位依次执行, 每执行完一个交易集合, 就将被执行的交易集合的 order_root, 以及执行后的 stateRoot 发给共识模块。在 Leader 打包交易拼装 <em>block</em> 时, 取最新收到的 state_root 作为最新状态参与共识.</p><p>Overlord 是在具体共识算法之上的解释层, 通过重新诠释共识的语义, 使得交易定序与状态共识解耦, 从而在实际运行中获得更高的交易处理能力。理论上, Overlord 能够基于几乎任何 BFT 类共识算法, 具体在我们的项目中则是基于改进的 Tendermint。</p><p>我们对 Tendermint 主要做了三点改进：</p><ol><li>将聚合签名应用到 Tendermint 中, 使共识的消息复杂度从 <img src="https://latex.codecogs.com/svg.latex?\inline&amp;space;O(n^{2})" title="O(n^{2})"> 降到 <img src="https://latex.codecogs.com/svg.latex?\inline&amp;space;O(n)" title="O(n)">, 从而能够支持更多的共识节点</li><li>在 <em>proposal</em> 中增加了 propose 交易区, 使新交易的同步与共识过程可并行</li><li>共识节点收到 <em>proposal</em> 后, 无需等 <em>block</em> 校验通过即可投 <em>prevote</em> 票, 而在投 <em>precommit</em> 票之前必须得到 <em>block</em> 校验结果, 从而使得区块校验与 <em>prevote</em> 投票过程并行</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="聚合签名"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#聚合签名" title="Direct link to heading">#</a>聚合签名</h4><p>在 Tendermint 共识协议中，节点在收到 <em>proposal</em> 之后对其投出 <em>prevote</em>，<em>prevote</em> 投票是全网广播给其他节点的。这时的通信复杂度是 <img src="https://latex.codecogs.com/svg.latex?\inline&amp;space;O(n^{2})" title="O(n^{2})">。使用聚合签名优化是所有的节点将 <em>prevote</em> 投票发给一个指定的 <em>Relayer</em> 节点，Relayer 节点可以是任何一个共识节点。Relayer 节点将收到的签名通过算法计算聚合签名，再用一个位图 (bit-vec) 表示是哪些节点的投票。将聚合签名和位图发送给其他节点，对于 <em>precommit</em> 投票同理。这样就将通信复杂度降到了 <img src="https://latex.codecogs.com/svg.latex?\inline&amp;space;O(n)" title="O(n)">。</p><p>如果 <em>Relayer</em> 出现故障，没有发送聚合签名给共识节点，或者 <em>Relayer</em> 作恶，只给小部分共识节点发送聚合签名，那么共识将会失活。我们采用超时投空票的方式解决这个问题。当节点在投出 <em>prevote</em> 投票之后，立即设置一个定时器，如果的超时时间内没有收到 <em>prevoteQC</em> 直接进入预提交状态，投出 <em>nil precommit</em> 投票。之后进入到下一个 round。如果预投票阶段正常，投出 <em>precommit</em> 之后同样设置一个定时器，如果超时没有收到 <em>precommitQC</em> 则直接进入下一个 round。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="同步并行"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#同步并行" title="Direct link to heading">#</a>同步并行</h4><p>Overlord 采用压缩区块（compact block）的方式广播 <em>CompactBlock</em>，即其 Body 中仅包含交易哈希，而非完整交易。共识节点收到 <em>CompactBlock</em> 后，需要同步获得其 Body 中包含的全部完整交易后才能构造出完整的 <em>block</em>。</p><p>我们在 proposal 里除了包含 <em>CompactBlock</em> 外，还额外增加了一个 <em>propose</em> <em>交易区，propose</em> 交易区中包含待同步的新交易的哈希。需要注意的是，这些交易与 <em>CompactBlock</em> 里包含的待定序的交易哈希并不重叠，当 <em>CompactBlock</em> 不足以包含交易池中所有的新交易时，剩余的新交易可以包含到 <em>propose</em> 交易区中提前同步。这在系统交易量很大的时候，可以提高交易同步与共识的并发程度，进一步提高交易处理能力.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="校验并行"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#校验并行" title="Direct link to heading">#</a>校验并行</h4><p>共识节点收到 <em>proposal</em> 后，将 <em>CompactBlock</em> 的校验(获得完整交易，校验交易的正确性) 与 <em>prevote</em> 投票并行，只有当收到 <em>prevote</em> 聚合签名和 <em>CompactBlock</em> 的检验结果后，才会投 <em>precommit</em> 票。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="overlord-架构"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#overlord-架构" title="Direct link to heading">#</a>Overlord 架构</h2><p>Overlord 共识由以下几个组件组成的：</p><ul><li><p>状态机(SMR)：根据输入消息的进行状态转换</p></li><li><p>状态存储(State)：用于存储提议，投票等状态</p></li><li><p>定时器(Timer)：设定超时时间触发状态机操作</p></li><li><p>Wal：用于读写 Wal 日志</p></li></ul><p>在 Overlord 共识架构中，当收到消息时，状态存储模块先对消息做基本检查。通过后，根据接收到的消息更新状态，并将消息传输给状态机。此外，为了保持活性还需要一个定时器，当超时时定时器调用接口触发状态机。状态机在做状态变更之后会抛出一个当前状态的事件，状态存储模块和定时器模块监听状态机抛出的事件，根据监听到的事件做相应的处理，例如写 Wal，发送投票，设置定时器等。在重启时状态存储模块先从 Wal 中读取数据，再发送给状态机。整体的架构如下图所示：</p><p><img src="/docs-img/arch_overlord.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="共识状态机smr"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#共识状态机smr" title="Direct link to heading">#</a>共识状态机(SMR)</h3><p>状态机模块是整个共识的逻辑核心，它主要的功能是状态变更和 <strong>lock</strong> 的控制。当收到消息触发时，根据收到的消息做状态变更，并将变更后的状态作为事件抛出。在我们的实现中，Overlord 使用一个应用 BLS 聚合签名优化的 Tendermint 状态机进行共识，整体的工作过程如下。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="提议阶段"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#提议阶段" title="Direct link to heading">#</a>提议阶段</h4><p>节点选择本轮的 <em>Leader</em>。</p><p><strong>Leader</strong>: 广播一个 <em>proposal</em></p><p><strong>Others</strong>: 设置一个定时器 T1，当收到 <em>proposal</em> 之后向 <em>Relayer</em> 发送 <em>prevote</em> 投票</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="预投票阶段"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#预投票阶段" title="Direct link to heading">#</a>预投票阶段</h4><p><strong>Relayer</strong>: 设置一个定时器 T2，对收到的 <em>prevote</em> 投票进行聚合并生成位图，将聚合后的投票和位图广播给其他节点</p><p><strong>Others</strong>: 设置一个定时器 T2，检查聚合的 <em>prevote</em> 投票的合法性，生成 <strong>PoLC</strong> 发送 <em>precommit</em> 投票</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="校验等待阶段"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#校验等待阶段" title="Direct link to heading">#</a>校验等待阶段</h4><p>所有节点设置一个定时器 T3，当收到对 <em>proposal</em> 的校验结果之后，进入预提交阶段</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="预提交阶段"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#预提交阶段" title="Direct link to heading">#</a>预提交阶段</h4><p><strong>Relayer</strong>: 设置一个定时器 T4，对收到的 <em>precommit</em> 投票进行聚合并生成位图，将聚合后的投票和位图广播给其他节点</p><p><strong>Others</strong>: 设置一个定时器 T4，检查聚合的 <em>precommit</em> 投票的合法性</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="提交阶段"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#提交阶段" title="Direct link to heading">#</a>提交阶段</h4><p>所有节点将 <em>proposal</em> 提交</p><p>共识状态机的状态转换图如下图所示：</p><p><img src="/docs-img/state_transition.png"></p><p>在工程中，我们将预投票阶段和校验等待阶段合并为一个阶段，共用一个超时时间。当状态机收到聚合后的投票和校验结果之后，进入到预提交阶段。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="状态机状态"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#状态机状态" title="Direct link to heading">#</a>状态机状态</h4><p>状态机模块需要存储的状态有：</p><ul><li><p><em>height</em>: 当前共识的高度</p></li><li><p><em>round</em>: 当前共识的轮次</p></li><li><p><em>step</em>: 当前所在的阶段</p></li><li><p><em>proposal_hash</em>: 可选，当前正在共识的哈希</p></li><li><p><em>lock</em>: 可选，当前是否已经达成 <strong>PoLC</strong></p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="数据结构"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#数据结构" title="Direct link to heading">#</a>数据结构</h4><p>状态机的触发结构如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> SMRTrigger </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> round</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> trigger_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TriggerType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><p>状态机的输出结构如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> SMREvent </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// New round event</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for state: update round,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for timer: set a propose step timer.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    NewRoundInfo </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        round</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock_round</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock_proposal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Prevote event,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for state: transmit a prevote vote,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for timer: set a prevote step timer.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PrevoteVote</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Precommit event,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for state: transmit a precommit vote,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for timer: set a precommit step timer.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PrecommitVote</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Commit event</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for state: do commit,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for timer: do nothing.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Stop event,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for state: stop process,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// for timer: stop process.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Stop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="状态机接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#状态机接口" title="Direct link to heading">#</a>状态机接口</h4><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Create a new SMR service.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Trigger a SMR action.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SMRTrigger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Goto a new consensus height.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">new_height</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="状态存储state"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#状态存储state" title="Direct link to heading">#</a>状态存储(State)</h3><p>状态存储模块是整个共识的功能核心，主要的功能为存储状态，消息分发，出块和密码学相关操作。在工作过程中，对于网络层传输来的消息，首先进行验签，校验消息的合法性。对通过的消息判断是否需要写入 Wal。之后将消息发送给状态机。状态存储模块时刻监听状态机抛出的事件，并根据事件作出相应的处理。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="存储状态"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#存储状态" title="Direct link to heading">#</a>存储状态</h4><p>状态存储模块需要存储的状态有：</p><ul><li><p><em>height</em>: 当前共识的高度</p></li><li><p><em>round</em>: 当前共识的轮次</p></li><li><p><em>proposals</em>: 缓存当前高度的所有的提议</p></li><li><p><em>votes</em>: 缓存当前高度的所有的投票</p></li><li><p><em>QCs</em>: 缓存当前高度的所有的 <em>QC</em></p></li><li><p><em>authority_manage</em>: 共识列表管理</p></li><li><p><em>is_leader</em>: 节点是不是 <em>leader</em></p></li><li><p><em>proof</em>: 可选，上一个 block 的证明</p></li><li><p><em>last_commit_round</em>: 可选，上一次提交的轮次</p></li><li><p><em>last_commit_proposal</em>: 可选，上一次提交的提议</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="消息分发"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#消息分发" title="Direct link to heading">#</a>消息分发</h4><p>发送消息时，根据消息及参数选择发送消息的方式（广播给其他节点或发送给 <em>Relayer</em>）。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="出块"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#出块" title="Direct link to heading">#</a>出块</h4><p>当状态存储模块监听到状态机抛出的 <code>NewRound</code> 事件时，通过一个确定性随机数算法判断自己是不是出块节点。如果是出块节点则提出一个 proposal。</p><p><em>确定性随机数算法</em>：因为 Overlord 共识协议允许设置不同的出块权重和投票权重，在判断出块时，节点将出块权重进行归一化，并投射到整个 <code>u64</code> 的范围中，使用当前 <code>height</code> 与 <code>round</code> 之和作为随机数种子，判断生成的随机数落入到<code>u64</code> 范围中的哪一个区间中，该权重对应的节点即为出块节点。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="密码学操作"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#密码学操作" title="Direct link to heading">#</a>密码学操作</h4><p>密码学操作包括如下方法：</p><ul><li><p>收到消息时，对消息进行验签</p></li><li><p>收到聚合投票时，验签并校验权重是否超过阈值</p></li><li><p>发出提议或投票时，对消息进行签名</p></li><li><p>自己是 <em>Relayer</em> 时，对收到的投票进行聚合</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="状态存储接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#状态存储接口" title="Direct link to heading">#</a>状态存储接口</h4><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="定时器"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#定时器" title="Direct link to heading">#</a>定时器</h3><p>当状态机运行到某些状态的时候，需要设定定时器以便超时重发等操作。定时器模块会监听状态机抛出的事件，根据事件设置定时器。当达到超时时间，调用状态机模块的接口触发超时。定时器与状态存储复用 <code>SMREvent</code> 和接口。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="wal"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#wal" title="Direct link to heading">#</a>Wal</h3><p>在共识过程中，需要将一些消息写入到 Wal 中。当重启时，状态存储模块首先从 Wal 中读取消息，回复重启前的状态。Wal 模块只与状态存储模块交互。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="overlord-接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#overlord-接口" title="Direct link to heading">#</a>Overlord 接口</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="共识接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#共识接口" title="Direct link to heading">#</a>共识接口</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[async_trait]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> Consensus</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Codec</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Send </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Sync </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Get a block of an height and return the block with its hash.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Check the correctness of a block. If is passed, return the integrated transcations to do</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// data persistence.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">check_block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Commit a given block to execute and return the rich status.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        commit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Commit</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Get an authority list of the given height.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_authority_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#393A34"><span class="token plain">        height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u64</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Node</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Broadcast a message to other replicas.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">broadcast_to_other</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OutputMsg</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Transmit a message to the Relayer, the third argument is the relayer&#x27;s address.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transmit_to_relayer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OutputMsg</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="密码学接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#密码学接口" title="Direct link to heading">#</a>密码学接口</h3><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> Crypto </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Hash a message.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">u8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Sign to the given hash by private key.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Aggregate signatures into an aggregated signature.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">aggregate_signatures</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        signatures</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Signature</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Verify a signature.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">verify_signature</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        signature</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Verify an aggregated signature.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">verify_aggregated_signature</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        aggregate_signature</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AggregatedSignature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">dyn</span><span class="token plain"> Error </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Send</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="wal-接口"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#wal-接口" title="Direct link to heading">#</a>Wal 接口</h4><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Save wal information.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Load wal information.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Bytes</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="overlord-配置"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#overlord-配置" title="Direct link to heading">#</a>Overlord 配置</h2><p>Overlord 提供随机出块和轮询出块两种出块方式。随机出块采用确定性随机算法计算 leader，轮询出块轮流选择 leader。默认为轮询出块，在轮询出块下，<code>propose_weight</code> 不生效。在 <code>Cargo.toml</code> 中的 overlord 依赖中可以选择出块方式，方法如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain"># 轮询出块</span></div><div class="token-line" style="color:#393A34"><span class="token plain">muta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> git </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://github.com/nervosnetwork/overlord&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;master&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"># 随机出块</span></div><div class="token-line" style="color:#393A34"><span class="token plain">muta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> git </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://github.com/nervosnetwork/overlord&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;master&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;random_leader&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div></div></article></div><div class="paginator_3VDt"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/advanced/transaction-block"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Transaction, Block and State</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/advanced/core/network"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">P2P Network »</h4></a></div></nav></div></div><div class="rightCol_38kP"><div class="table-of-contents tableOfContents_tVyB"><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#目标" class="contents__link">目标</a></li><li><a href="#设计背景" class="contents__link">设计背景</a></li><li><a href="#overlord-协议" class="contents__link">Overlord 协议</a><ul><li><a href="#总体设计" class="contents__link">总体设计</a></li><li><a href="#协议描述" class="contents__link">协议描述</a></li></ul></li><li><a href="#overlord-架构" class="contents__link">Overlord 架构</a><ul><li><a href="#共识状态机smr" class="contents__link">共识状态机(SMR)</a></li><li><a href="#状态存储state" class="contents__link">状态存储(State)</a></li><li><a href="#定时器" class="contents__link">定时器</a></li><li><a href="#wal" class="contents__link">Wal</a></li></ul></li><li><a href="#overlord-接口" class="contents__link">Overlord 接口</a><ul><li><a href="#共识接口" class="contents__link">共识接口</a></li><li><a href="#密码学接口" class="contents__link">密码学接口</a></li></ul></li><li><a href="#overlord-配置" class="contents__link">Overlord 配置</a></li></ul></div><div class="section"><div class="title">Resources</div><ul class="contents"><li><a href="https://github.com/nervosnetwork/muta-docs/edit/master/docs/advanced/core/overlord.md" class="contents__link" target="_blank"><i class="feather icon-edit-1"></i> Edit this page</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><div class="mailing-list"><form action="https://dev.us17.list-manage.com/subscribe/post?u=a7b19925733ee6bf88e045485&amp;id=d8c4724e17" method="post" class="mailing-list--form"><button class="button button--primary button--undefined" type="submit">❤ Subscribe us for Muta updates ❤ </button></form></div></div><div><a href="https://twitter.com/nervosnetwork" target="_blank"><i class="feather icon-twitter" alt="Muta&#x27;s Twitter"></i></a>    <a href="https://discord.com/invite/rN35fe8" target="_blank"><i class="feather icon-message-circle" alt="Muta&#x27;s Chat"></i></a>    <a href="https://github.com/nervosnetwork/muta" target="_blank"><i class="feather icon-github" alt="Muta&#x27;s Github Repo"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/about/what-is-muta/">What is Muta?</a></li><li class="footer__item"><a class="footer__link-item" href="/community/#team">The Team</a></li><li class="footer__item"><a class="footer__link-item" href="/contact/">Contact Us</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Development</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/setup/getting-started/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dev/dev-overview/">Service Dev</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dev/dex/">Dapp Dev</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://talk.nervos.org/">Forum</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://discord.com/invite/rN35fe8">Discord</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com/nervosnetwork">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta">GitHub</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://nervos.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_3L_r"></a></div>Copyright © 2020 Nervos Fundation<br></div></div></footer>
</div>

<script src="/styles.aab16a3e.js"></script>

<script src="/runtime~main.03453cf4.js"></script>

<script src="/main.e4220dee.js"></script>

<script src="/1.a4d1db7c.js"></script>

<script src="/2.ddac714a.js"></script>

<script src="/3.18f4c7ce.js"></script>

<script src="/1be78505.0761eff7.js"></script>

<script src="/c6c6e257.5904db9a.js"></script>

<script src="/5.15d1d23d.js"></script>

<script src="/17896441.8bceb62d.js"></script>

<script src="/d9b1b66c.8da74149.js"></script>


</body>
</html>