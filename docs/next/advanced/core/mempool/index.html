<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-134504127-4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-134504127-4",{})</script>
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Muta Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Muta Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">

<title data-react-helmet="true">Mempool | Docs | Muta</title>

<meta data-react-helmet="true" property="og:title" content="Muta"><meta data-react-helmet="true" name="docsearch:version" content="next"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="## 功能介绍"><meta data-react-helmet="true" property="og:description" content="## 功能介绍"><meta data-react-helmet="true" property="og:url" content="docs.muta.dev/docs/next/advanced/core/mempool">

<link data-react-helmet="true" rel="shortcut icon" href="/img/muta-logo.png">


<link rel="stylesheet" href="/styles.280b09d0.css">


<link rel="preload" href="/styles.aab16a3e.js" as="script">

<link rel="preload" href="/runtime~main.68846c32.js" as="script">

<link rel="preload" href="/main.e4220dee.js" as="script">

<link rel="preload" href="/1.a4d1db7c.js" as="script">

<link rel="preload" href="/2.ddac714a.js" as="script">

<link rel="preload" href="/3.18f4c7ce.js" as="script">

<link rel="preload" href="/1be78505.0761eff7.js" as="script">

<link rel="preload" href="/c6c6e257.5904db9a.js" as="script">

<link rel="preload" href="/5.15d1d23d.js" as="script">

<link rel="preload" href="/17896441.8bceb62d.js" as="script">

<link rel="preload" href="/fcd61e54.57e84d39.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_OaSq"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/muta.svg" alt="muta"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/about/what-is-muta">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/about/what-is-muta">Master/Unreleased</a></li><li><a class="dropdown__link" href="/docs/about/what-is-muta">0.2.0-beta.4/Latest Stable</a></li></ul></div><a class="navbar__item navbar__link" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/community/">Communtiy</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a activeclassname="navbar__link--active" class="navbar__item navbar__link">Translate</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/docs_zh/about/what-is-muta">中文</a></li><li><a class="dropdown__link" href="/docs/about/what-is-muta">English</a></li></ul></div><a class="navbar__item navbar__link" href="/versions">v0.2.0-beta.4</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/muta.svg" alt="muta"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" position="left" href="/docs/about/what-is-muta">Docs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/about/what-is-muta">Master/Unreleased</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/about/what-is-muta">0.2.0-beta.4/Latest Stable</a></li></ul></li><li class="menu__list-item"><a class="menu__link" position="left" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" position="right" href="/community/">Communtiy</a></li><li class="menu__list-item"><a activeclassname="navbar__link--active" class="menu__link menu__link--sublist" position="right">Translate</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/docs_zh/about/what-is-muta">中文</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/about/what-is-muta">English</a></li></ul></li><li class="menu__list-item"><a class="menu__link" position="right" href="/versions">v0.2.0-beta.4</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="menu__link header-github-link" position="right"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container_3Vzv container container--l"><div class="sidebar_dgnY"><div class="docs-sidebar sidebar_25T_"><a class="sidebarLogo_3JkW" href="/"></a><div class="menu menu--responsive menu_1e9D"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_1hKf" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><div class="title">About</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/about/what-is-muta/">What is Muta?</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/about/concepts/">Basic Concepts</a></li></ul></li><li class="menu__list-item"><div class="title">Setup</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/getting-started/">Getting Started</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/setup/config/">Configuration</a><ul class="menu__list"><li class="menu__list-item menu__list-item-hidden"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/config/">hidden</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/genesis-config/">Genesis Configuration</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/node-config/">Node Configuration</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/cargo-config/">Cargo configuration</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/setup/deploy/">Deployment</a></li></ul></li><li class="menu__list-item"><div class="title">Development</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/dev-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-dev/">Service Dev Guide</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/dev/service-list/service-list/">Service List</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/service-list/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/metadata-service/">Metadata Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/asset-service/">Asset Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/auth-service/">Authorization Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/service-list/multi-sig-service/">Multi-signature Service</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/poe-chain/">Develop a Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/dev/dex/">Develop a Dapp Chain</a></li></ul></li><li class="menu__list-item"><div class="title">Advanced</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/arch/">Architecture</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/transaction-block/">Transaction, Block and State</a></li><li class="menu__list-item"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/docs/next/advanced/core/overlord/">Core Design</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/overlord/">Overlord</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/network/">P2P Network</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/mempool/">Mempool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/core/storage/">Storage</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/advanced/crypto/">Cryptography</a></li></ul></li><li class="menu__list-item"><div class="title">Toolchain</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/sdk-js/">JS SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/sdk-java/">JAVA SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/muta-cli/">Muta CLI</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/benchmark-tool/">Muta Benchmark Tool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/toolchain/keypair/">Muta Keypair Tool</a></li></ul></li><li class="menu__list-item"><div class="title">Reference</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/docs/next/ref/faq/">FAQ</a></li><li class="menu__list-item"><a class="menu__link" to="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/" target="_blank" rel="noreferrer noopener" href="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/">Contributing</a></li></ul></li></ul></div></div></div><main class="main_2vyu"><div><div class="container_2j_u"><div class="leftCol_3JzO"><div class="docItemContainer_"><article><span style="vertical-align:top" class="badge badge--info">Version: next</span><header><div class="badges"></div><h1 class="docTitle_cWlf">Mempool</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="功能介绍"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#功能介绍" title="Direct link to heading">#</a>功能介绍</h2><p>Mempool 的作用是收集合法的新交易，以向 Consensus 模块提供用于构建区块的交易集合。</p><p>具体来说，当节点成为本轮共识的 Leader 后，会向 Mempool 请求两个交易哈希集合用于构建共识提案。
一个交易哈希集合叫 <code>ordered_tx_hashes</code>，用于构建区块，参与本轮共识过程。
另一个叫 <code>propose_tx_hashes</code>，当 Mempool 中的交易数量超出一个区块所能放入的最大交易数时，
Mempool 会将全部或部分溢出的交易哈希放入<code>propose_tx_hashes</code> 中。</p><p>其他节点收到共识提案后，一方面检查 <code>ordered_tx_hashes</code> 所对应的完整交易是否都在本地 Mempool 中，如有缺失则向提案发起者同步交易。
如果在一定时间内无法收齐交易，则该提案视为非法。另一方面检查 <code>propose_tx_hashes</code>，同步缺失的交易，以提高待未来共识的交易的同步率。</p><p>当节点收集到合法共识提案的 2/3+ 的 Prevote 投票时，该提案即达成锁定条件，
Consensus 模块会通过 Mempool 拿到 <code>ordered_tx_hashes</code> 所对应的全部完整交易，并进行持久化，以保证共识安全。</p><p>当提案达成共识后，Mempool 要删除已达成共识的交易。</p><p>基于以上功能要求，在 Mempool 中有以下接口：</p><ul><li><code>insert</code>: 新交易通过必要的检查后插入 Mempool。详细的检查过程见<a href="#%E4%BA%A4%E6%98%93%E7%9A%84%E5%90%88%E6%B3%95%E6%80%A7%E6%A3%80%E6%9F%A5">交易的合法性检查</a>。</li><li><code>package</code>: 从 Mempool 中打包两个交易哈希集合给 Consensus 用于构建共识提案。</li><li><code>flush</code>: 从 Mempool 中删除达成共识的交易。</li><li><code>get_full_txs</code>: 从 Mempool 中返回指定的交易哈希集合所对应的完整交易。</li><li><code>ensure_order_txs</code>: 确保 <code>ordered_tx_hashes</code> 所对应的完整交易都在 Mempool 中，对于缺失的交易会通过 Network 同步。</li><li><code>sync_propose_txs</code>: 检查 <code>propose_tx_hashes</code> 所对应的完整交易是否都在 Mempool 中，并同步缺失的交易。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="交易的合法性检查"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#交易的合法性检查" title="Direct link to heading">#</a>交易的合法性检查</h2><ol><li>交易池是否已满</li><li>交易的字节大小是否超出阈值</li><li>交易的 <code>cycles_limit</code> 是否超出阈值</li><li>交易的 <code>chain_id</code> 是否正确</li><li>交易的 <code>timeout</code> 是否在当前的合法窗口内</li><li>交易是否与交易池内已有的交易重复</li><li>交易是否与已上链的交易重复</li><li>交易的签名是否正确</li><li>交易的发起者的地址是否被授权</li><li>交易的发起者的账户余额是否足够支付最低交易费</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="与其他模块的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与其他模块的调用关系" title="Direct link to heading">#</a>与其他模块的调用关系</h2><p><img src="/docs-img/txpool_module_relationship.png" alt="image"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-graphql-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-graphql-的调用关系" title="Direct link to heading">#</a>与 Graphql 的调用关系</h4><ul><li>用户使用 Graphql 客户端生成交易后，Graphql 会调用 Mempool 的 <code>insert</code> 接口，将交易插入 Mempool。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-network-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-network-的调用关系" title="Direct link to heading">#</a>与 Network 的调用关系</h4><ul><li>其他用户生成的，通过网络发来的交易，Network 会调用 Mempool 的 <code>insert</code> 接口，将交易插入 Mempool。</li><li>当需要向其他节点获取指定的完整交易时，Mempool 会调动 Network 的 <code>pull_txs</code> 接口，以获取指定的交易。</li><li>当其他节点请求指定的完整交易时，Network 会调用 Mempool 的 <code>get_full_txs</code> 接口，以获得指定的交易。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-executor-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-executor-的调用关系" title="Direct link to heading">#</a>与 Executor 的调用关系</h4><ul><li>在对要 <code>insert</code> 的交易进行检查时，Mempool 会调用 Executor 的 <code>read</code> 接口，查询交易发起者的授权情况以及账户余额，
以完成相应的检查。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-storage-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-storage-的调用关系" title="Direct link to heading">#</a>与 Storage 的调用关系</h4><ul><li>在对要  <code>insert</code>  的交易进行检查时，Mempool 会调用 Storage 的 <code>get_transaction_by_hash</code> 接口用于查重。</li><li>在对要  <code>insert</code>  的交易进行检查时，Mempool 会调用 Storage 的 <code>get_latest_block</code> 接口用于获取最新的区块，
进而获得必要的状态，用于 <code>chain_id</code> 的检查以及用于创建 Executor 以完成相应的检查。</li><li>在 <code>package</code> 和 <code>flush</code> 时，Mempool 需要调用 Storage 的 <code>get_latest_block</code> 接口以获取最新的区块，
进而得到最新高度作为必要的状态以完成相应的任务。</li><li>在 <code>get_full_txs</code> 时，Mempool 必要时会调用 Storage 的 <code>get_transactions</code> 接口以获得指定的完整交易。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-consensus-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-consensus-的调用关系" title="Direct link to heading">#</a>与 Consensus 的调用关系</h4><ul><li>当节点是当前共识轮次的 Leader 时，Consensus 会调用 Mempool 的 <code>package</code> 接口，以获得用于构造共识提案的两个交易哈希集合。</li><li>当节点收到共识提案时，Consensus 会调用 Mempool 的 <code>ensure_order_txs</code> 接口，
检查提案中的 <code>ordered_tx_hashes</code> 所对应的完整交易是否都在 Mempool 中，
对于缺失的交易，Mempool 会调用 Network 的 <code>pull_txs</code> 接口获取对应的完整交易。</li><li>当节点收到共识提案时，Consensus 会调用 Mempool 的 <code>sync_propose_txs</code> 接口，
检查提案中的 <code>propose_tx_hashes</code> 所对应的完整交易是否都在 Mempool 中，
对于缺失的交易，Mempool 会调用 Network 的 <code>pull_txs</code> 接口获取对应的完整交易。</li><li>当某个提案达成锁定条件时，Consensus 会调用 Mempool 的 <code>get_full_txs</code> 接口，
以获得该提案中的 <code>ordered_tx_hashes</code> 所对应的完整交易，并进行持久化，确保被锁住的提案的完整的 <code>ordered_tx</code> 不会丢失。</li><li>当某个提案达成共识后，Consensus 会调用 Mempool 的 <code>flush</code> 接口，以从 Mempool 中删除达成共识的交易。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="与-synchronization-的调用关系"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#与-synchronization-的调用关系" title="Direct link to heading">#</a>与 Synchronization 的调用关系</h4><ul><li>当收到比最新高度高一个块的完整的合法区块后，Synchronization 会调用 Mempool 的 <code>flush</code> 接口，从 Mempool 中删除达成共识的交易。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="模块文件"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#模块文件" title="Direct link to heading">#</a>模块文件</h2><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-undefined codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mempool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">│   Cargo.toml    </span></div><div class="token-line" style="color:#393A34"><span class="token plain">│</span></div><div class="token-line" style="color:#393A34"><span class="token plain">└───src</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   context.rs      // 获取交易的上下文，用于判断交易是本地 Graphql 发起还是来自网络</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   lib.rs          // 实现 Mempool 的所有对外接口</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   map.rs          // 实现并发 map</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   tx_cache.rs     // 实现 Mempool 的核心数据结构</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    └───adapter</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   │   mod.rs      // 实现 mempool 适配器，包含 Mempool 所需的所有外部资源</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   │   message.rs  // 定义 Mempool 的网络通信消息</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    │   │  </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    └───test</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="具体设计"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#具体设计" title="Direct link to heading">#</a>具体设计</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="设计要求"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#设计要求" title="Direct link to heading">#</a>设计要求</h3><ol><li><em>按插入顺序打包</em>。
为避免用户的合法新交易在交易池中始终无法被打包，并兼顾一定的公平性，交易池在打包时，
总体上是按照交易插入交易池的顺序打包。</li><li><em>支持高并发</em>。
交易的插入需要满足高并发的要求，插入与打包可并行进行。</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="核心数据结构和实现思路"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#核心数据结构和实现思路" title="Direct link to heading">#</a>核心数据结构和实现思路</h3><p>为了满足以上要求，我们用支持并发的 map 和 queue 结构共享存储交易数据，map 可快速查询和删除，而 queue 满足先入先出的打包要求。
Mempool 的核心数据结构如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> TxCache </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用 queue 实现先入先出的打包功能. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用两个 queue 轮流存储交易. 一个 queue 当前轮值, 另一个则作为替补. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 打包时从当前轮值的 queue 中顺序打包.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    queue_0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Queue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    queue_1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Queue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用 map 完成高效的随机查询和删除交易.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    map</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 指示当前轮值的 queue, true 为 queue_0, false 为 queue_1.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    is_zero</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用于原子操作，以妥善处理打包与插入的并发问题. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    concurrent_count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicUsize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// 用于 map 和 queue 中共享的交易结构</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> SharedTx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Arc</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TxWrapper</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> TxWrapper </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SignedTransaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 该交易是否被 map 删除，有该标识的交易在打包交易时会被跳过，并且从 queue 中删除</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    removed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 避免重复同步的标识，有该标识的交易在打包 propose 交易时会被跳过</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    proposed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// 用于存储共识同步返回的交易</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CallbackCache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SignedTransaction</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Mempool 打包返回给共识模块的数据结构</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> MixedTxHashes </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    order_tx_hashes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    propose_tx_hashes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><p>通过所有检查的合法新交易在插入 Mempool 时，首先包装为 <code>TxWrapper</code>（<code>removed</code> 和 <code>proposed</code> 均设置为 <code>false</code>）。
进而包装为 <code>SharedTx</code> 插入 <code>TxCache</code> 中（插入轮值 <code>queue</code> 的尾部，以及 <code>map</code> 中）。 </p><p>Mempool 收到共识的打包请求时，返回 <code>MixedTxHashes</code>，其中包含用于共识的 <code>order_tx_hashes</code>
和用于提前同步的 <code>propose_tx_hashes</code>。</p><p>打包算法大致如下:
1. 从轮值 <code>queue</code> 的头部开始依次弹出 <code>SharedTx</code>，
直到全部弹出或者达到 <code>cycles_limit </code>阈值为止，将这些交易哈希插入 <code>order_tx_hashes</code> 中。
2. 如果第一步结束后，轮值 <code>queue</code> 中还有交易，则继续弹出 <code>SharedTx</code>，
直到全部弹出或达到 <code>cycles_limit</code> 阈值为止，将这些交易哈希插入 <code>propose_tx_hashes</code> 中。
3. 如果第二步结束后，轮值 <code>queue</code> 依然不为空，则继续弹出 <code>SharedTx</code>。
（以上三步弹出的 <code>SharedTx</code> ，按弹出顺序依次插入到替补 <code>queue</code> 中，以维持 <code>SharedTx</code> 插入 Mempool 的顺序。）
4. 当轮值 <code>queue</code> 全部弹出后，交换两个 <code>queue</code> 的角色，即轮值 <code>queue</code> 成为替补 <code>queue</code>，反之亦然。</p><p>在打包过程中并发插入的合法新交易都会插入到轮值 <code>queue</code> 中，在 <code>queue</code> 的角色切换之时，
有很小的概率出现少量新插入的交易排在老交易之前，使打包顺序不能完全与交易插入 Mempool 的顺序一致，
但是由于数量极少且很难被利用，因而影响不大。</p><p>Mempool 的插入和打包过程如下图所示。</p><p><img src="/docs-img/mempool_process.png" alt="image"></p></div></article></div><div class="paginator_3VDt"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/advanced/core/network"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« P2P Network</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/advanced/core/storage"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Storage »</h4></a></div></nav></div></div><div class="rightCol_38kP"><div class="table-of-contents tableOfContents_tVyB"><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#功能介绍" class="contents__link">功能介绍</a></li><li><a href="#交易的合法性检查" class="contents__link">交易的合法性检查</a></li><li><a href="#与其他模块的调用关系" class="contents__link">与其他模块的调用关系</a></li><li><a href="#模块文件" class="contents__link">模块文件</a></li><li><a href="#具体设计" class="contents__link">具体设计</a><ul><li><a href="#设计要求" class="contents__link">设计要求</a></li><li><a href="#核心数据结构和实现思路" class="contents__link">核心数据结构和实现思路</a></li></ul></li></ul></div><div class="section"><div class="title">Resources</div><ul class="contents"><li><a href="https://github.com/nervosnetwork/muta-docs/edit/master/docs/advanced/core/mempool.md" class="contents__link" target="_blank"><i class="feather icon-edit-1"></i> Edit this page</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><div class="mailing-list"><form action="https://dev.us17.list-manage.com/subscribe/post?u=a7b19925733ee6bf88e045485&amp;id=d8c4724e17" method="post" class="mailing-list--form"><button class="button button--primary button--undefined" type="submit">❤ Subscribe us for Muta updates ❤ </button></form></div></div><div><a href="https://twitter.com/nervosnetwork" target="_blank"><i class="feather icon-twitter" alt="Muta&#x27;s Twitter"></i></a>    <a href="https://discord.com/invite/rN35fe8" target="_blank"><i class="feather icon-message-circle" alt="Muta&#x27;s Chat"></i></a>    <a href="https://github.com/nervosnetwork/muta" target="_blank"><i class="feather icon-github" alt="Muta&#x27;s Github Repo"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/about/what-is-muta/">What is Muta?</a></li><li class="footer__item"><a class="footer__link-item" href="/community/#team">The Team</a></li><li class="footer__item"><a class="footer__link-item" href="/contact/">Contact Us</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Development</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/setup/getting-started/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dev/dev-overview/">Service Dev</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dev/dex/">Dapp Dev</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://talk.nervos.org/">Forum</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://discord.com/invite/rN35fe8">Discord</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com/nervosnetwork">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta">GitHub</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://nervos.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_3L_r"></a></div>Copyright © 2020 Nervos Fundation<br></div></div></footer>
</div>

<script src="/styles.aab16a3e.js"></script>

<script src="/runtime~main.68846c32.js"></script>

<script src="/main.e4220dee.js"></script>

<script src="/1.a4d1db7c.js"></script>

<script src="/2.ddac714a.js"></script>

<script src="/3.18f4c7ce.js"></script>

<script src="/1be78505.0761eff7.js"></script>

<script src="/c6c6e257.5904db9a.js"></script>

<script src="/5.15d1d23d.js"></script>

<script src="/17896441.8bceb62d.js"></script>

<script src="/fcd61e54.57e84d39.js"></script>


</body>
</html>